<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta property="og:title" content="Fake-Face Checker" />
    <meta property="og:description" content="Detect fake portraits generated by this-person-does-not-exist" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://tomhumphries.github.com/fake-detector" />
    <meta property="og:image" content="https://tomhumphries.github.com/fake-detector/images/ogmeta.png" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Fake-Face Checker</title>

    <script src="./js/face-api.min.js"></script>

  </head>
  <body>
    <div class="container text-center">
        <div class="py-3">
            <h1 class="display-1">Fake-Face Checker</h1>
            <p>Detect AI generated faces created by <a href="https://this-person-does-not-exist.com" target="_blank">this-person-does-not-exist</a>.</p>
        </div>
        <div class="row justify-content-center">
            <div class="col-lg-5 p-3">
                <div class="card text-center shadow" id="card">
                    <h2 class="fs-1 py-5" id="placeholder">Drop a picture of a face here</h2>
                    <img id="testImage" class="card-img-top" />
                    <canvas id="overlay" style="display: none;"></canvas>

                    <div class="card-body text-center" style="display: none;" id="real-person">
                        <h1>Probably Real</h1>
                    </div>

                    <div class="card-body text-center" style="display: none;" id="fake-person">
                        <h1>Possibly Fake</h1>
                        <p>The positioning of the eyes in this image match the positions used in fake-people images.</p>
                    </div>
                    
                    <div class="card-body text-center" style="display: none;" id="no-person">
                        <h1>No Person Detected</h1>
                        <p>The resolution of the image may be too low.</p>
                    </div>
                    
                    <div class="card-body text-center" style="display: none;" id="loading-result">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Analysing picture...</p>
                        <p>(The first face checked can take a few seconds)</p>
                    </div>

                    <div class="card-footer">
                        <input id="myFileUpload" class="form-control" type="file" accept=".jpg, .jpeg, .png">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="py-3 my-4">
        <hr>
        <p class="text-center text-muted">Favicon generated by <a href="https://favicon.io/" target="_blank">Favicon.io</a>.</p>
        <p class="text-center text-muted"><a href="https://github.com/justadudewhohacks/face-api.js" target="_blank">face-api.js</a> is a JavaScript face recognition API for the browser and nodejs by <a href="https://github.com/justadudewhohacks" target="_blank">justadudewhohacks</a> implemented on top of <a href="https://github.com/tensorflow/tfjs" target="_blank"> tensorflow.js core</a>.
        </p>
        <p class="text-center text-muted">Fake-Face Checker created by <a href="https://github.com/TomHumphries" target="_blank">Thomas Humphries</a>.</p>
    </footer>

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        init()
    
        const placeholder = document.getElementById("placeholder");
        const cardEl = document.getElementById("card");
        const canvas = document.getElementById("overlay");
        const image = document.getElementById("testImage");
        const fileInput = document.getElementById('myFileUpload');

        const real_person = document.getElementById('real-person');
        const fake_person = document.getElementById('fake-person');
        const no_person = document.getElementById('no-person');
        const loading_result = document.getElementById('loading-result');
        
        let imageFile;
        
        fileInput.addEventListener('change', onFileInputChanged);
        document.addEventListener('drop', handleDrop, false)
        document.addEventListener('dragenter', handlerFunction, false);
        document.addEventListener('dragleave', handlerFunction, false);
        document.addEventListener('dragover', handlerFunction, false);

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            // console.log({event})
            let dt = event.dataTransfer;
            let files = dt.files;
            fileInput.files = files;
            onFileInputChanged()
        }

        function handlerFunction(event) {
            event.preventDefault()
            event.stopPropagation()
        }

        async function init() {
            await faceapi.loadSsdMobilenetv1Model('./models')
            await faceapi.loadFaceLandmarkModel('./models');
        }

        async function onFileInputChanged() {
            imgFile = fileInput.files[0];
            processImage();
        }

        async function processImage() {
            // create an HTMLImageElement from a Blob
            placeholder.style.display = "none";
            const img = await faceapi.bufferToImage(imgFile);
            document.getElementById('testImage').src = img.src;
            
            setIsLoading();
            hideCanvas();
            
            setTimeout(() => {
                detect();
            }, 1);
        }
    
        async function detect() {
            canvas.width = image.width;
            canvas.height = image.height;
            // ctx = canvas.getContext("2d");
            // ctx.fill();

            const displaySize = { width: image.width, height: image.height };
            const detectionsWithLandmarks = await faceapi
                .detectSingleFace(image)
                .withFaceLandmarks();
            console.log({detectionsWithLandmarks});

            if (!detectionsWithLandmarks) {
                setNoPerson();
                return;
            }

            const resizedResults = faceapi.resizeResults(detectionsWithLandmarks, displaySize);
            // console.log({resizedResults});

            const leftEye = [...resizedResults.landmarks.getLeftEye()];
            const rightEye = [...resizedResults.landmarks.getRightEye()];
            
            let eyeLocations = getEyeLocations(leftEye, rightEye, image.width, image.height);
            console.log(`left: ${eyeLocations.left.x.toFixed(3)}, ${eyeLocations.left.y.toFixed(3)}`)
            console.log(`right: ${eyeLocations.right.x.toFixed(3)}, ${eyeLocations.right.y.toFixed(3)}`)

            faceapi.draw.drawFaceLandmarks(canvas, resizedResults, { drawLines: true });

            // show canvas and fix image
            showCanvas();

            let isFake = checkLandmarks(eyeLocations);
            if (isFake) {
                setIsFake();
            } else {
                setIsReal();
            }


    
        }

        function hideAllResults() {
            real_person.style.display = "none";
            fake_person.style.display = "none";
            no_person.style.display = "none";
            loading_result.style.display = "none";
        }

        function hideCanvas() {
            image.style.position = 'relative';
            canvas.style.display = 'none';
            canvas.style.position = 'relative';
        }
        function showCanvas() {
            image.style.position = 'absolute';
            canvas.style.display = 'block';
            canvas.style.position = 'relative';
        }
        function setIsLoading() {
            cardEl.className = "card bg-primary text-white";
            hideAllResults();
            loading_result.style.display = "block";
        }
        function setIsFake() {
            cardEl.className = "card bg-danger text-white";
            hideAllResults();
            fake_person.style.display = "block";
        }
        function setIsReal() {
            cardEl.className = "card bg-success text-white";
            hideAllResults();
            real_person.style.display = "block";
        }
        function setNoPerson() {
            cardEl.className = "card bg-warning text-dark";
            hideAllResults();
            no_person.style.display = "block";
        }
        
        function checkLandmarks(eyes) {
            const left_xmin = 0.40;
            const left_xmax = 0.45;
            const right_xmin = 0.55;
            const right_xmax = 0.60;
            const ymin = 0.45;
            const ymax = 0.48;
            if (eyes.left.x < left_xmin) return false;
            if (eyes.left.x > left_xmax) return false;
            if (eyes.right.x < right_xmin) return false;
            if (eyes.right.x > right_xmax) return false;
            if (eyes.left.y < ymin) return false;
            if (eyes.left.y > ymax) return false;
            return true
        }
    
        function getEyeLocations(leftEye, rightEye, width, height) {
            // console.log({leftEye, rightEye, width, height})
            // const leftEyeX = leftEye.map(pos => pos._x).reduce((acc,v,i,a)=>(acc+v/a.length),0);
            // const rightEyeX = rightEye.map(pos => pos._x).reduce((acc,v,i,a)=>(acc+v/a.length),0);
            // const leftEyeY = leftEye.map(pos => pos._y).reduce((acc,v,i,a)=>(acc+v/a.length),0);
            // const rightEyeY = rightEye.map(pos => pos._y).reduce((acc,v,i,a)=>(acc+v/a.length),0);
            const leftEyeX = Math.max(...leftEye.map(pos => pos._x));
            const rightEyeX = Math.min(...rightEye.map(pos => pos._x));
            const leftEyeY = leftEye.map(pos => pos._y).reduce((acc,v,i,a)=>(acc+v/a.length),0);
            const rightEyeY = rightEye.map(pos => pos._y).reduce((acc,v,i,a)=>(acc+v/a.length),0);
    
            const leftEyeXRatio = (leftEyeX / width);
            const leftEyeYRatio = (leftEyeY / height);
            const rightEyeXRatio = (rightEyeX / width);
            const rightEyeYRatio = (rightEyeY / height);
            // console.log({leftEyeXRatio, leftEyeYRatio, rightEyeXRatio, rightEyeYRatio})
            return {
                left: {
                    x: leftEyeXRatio,
                    y: leftEyeYRatio,
                },
                right: {
                    x: rightEyeXRatio,
                    y: rightEyeYRatio,
                },
            }
        }
    </script>
  </body>
</html>